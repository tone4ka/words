# Система аутентификации с localStorage

## Описание

Добавлена система сохранения состояния авторизации в localStorage с автоматической проверкой истечения сессии и обновлением токенов.

## Функциональность

### 1. Сохранение в localStorage

- **Автоматическое сохранение**: При успешной авторизации/регистрации данные пользователя сохраняются в localStorage
- **Временные метки**: Сохраняется время создания сессии и время истечения токена
- **Безопасность**: Автоматическая очистка при истечении времени

### 2. Проверка сессии

- **При запуске**: Автоматическая проверка сохранённой сессии при загрузке приложения
- **Периодическая проверка**: Каждые 5 минут для авторизованных пользователей
- **Валидация токенов**: Проверка действительности токенов через Supabase API

### 3. Обновление токенов

- **Автоматическое обновление**: Токены обновляются за 5 минут до истечения
- **Обработка ошибок**: При неудачном обновлении пользователь автоматически разлогинивается
- **Seamless UX**: Пользователь не замечает процесс обновления токенов

### 4. Очистка данных

- **При выходе**: Автоматическая очистка всех данных при logout
- **При истечении**: Очистка при истечении максимального времени сессии (24 часа)
- **При ошибках**: Очистка при обнаружении повреждённых данных

## Технические детали

### Утилиты (utils/auth.ts)

#### `saveUserToStorage(user, expiresAt?)`

Сохраняет данные пользователя с временными метками

#### `loadUserFromStorage()`

Загружает пользователя с проверкой времени жизни сессии

#### `clearUserFromStorage()`

Полностью очищает все данные авторизации

#### `shouldRefreshToken()`

Проверяет, нужно ли обновить токен (< 5 минут до истечения)

### Redux Actions

#### Новые действия:

- `checkSession` - проверка локальной сессии
- `sessionExpired` - обработка истечения сессии
- `auth/checkSessionRequest` - запрос проверки сессии в Supabase
- `auth/initializeAuth` - инициализация при запуске приложения

### Саги (authSaga.ts)

#### `checkSessionSaga`

- Проверяет текущую сессию в Supabase
- Обновляет токены при необходимости
- Обрабатывает истечение сессии

#### `initializeAuthSaga`

- Выполняется при запуске приложения
- Восстанавливает сессию из localStorage или Supabase

## Константы и настройки

### Время жизни сессии

- **Максимальное время**: 24 часа в localStorage
- **Обновление токенов**: за 5 минут до истечения
- **Периодическая проверка**: каждые 5 минут

### Ключи localStorage

```typescript
AUTH_STORAGE_KEYS = {
  USER: "auth_user",
  TIMESTAMP: "auth_timestamp",
  EXPIRES_AT: "auth_expires_at",
};
```

## Использование

### Автоматическая работа

Система работает автоматически:

1. При логине/регистрации сохраняет данные
2. При запуске приложения восстанавливает сессию
3. Периодически проверяет и обновляет токены
4. При выходе или ошибках очищает данные

### Пользовательский опыт

- **Постоянная авторизация**: Пользователь остаётся залогиненным между сессиями
- **Безопасность**: Автоматический выход при истечении токенов
- **Бесшовность**: Обновление токенов происходит незаметно для пользователя

## Обработка ошибок

### Сценарии автоматического logout:

1. Истечение максимального времени сессии (24 часа)
2. Истечение токена без возможности обновления
3. Ошибки при работе с localStorage
4. Ошибки при проверке сессии в Supabase
5. Повреждённые данные в localStorage

### Уведомления пользователя:

- При истечении сессии показывается сообщение: "Session expired. Please log in again."
- Пользователь автоматически перенаправляется к форме входа
